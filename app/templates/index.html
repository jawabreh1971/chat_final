<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>Ù„ÙˆØ­Ø© Ø§Ù„Ù‚Ø´Ø§Ø· â€“ PAI-6 v8 (HTML Edition)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #020617;
      color: #e5e7eb;
    }
    #root {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    header {
      padding: 12px 20px;
      border-bottom: 1px solid rgba(148,163,184,0.3);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .bubble-user {
      background: linear-gradient(to left, #0369a1, #0f766e);
      color: #fff;
      padding: 10px 14px;
      border-radius: 12px;
      margin: 6px 0;
      max-width: 85%;
      align-self: flex-start;
      font-size: 14px;
      line-height: 1.6;
      white-space: pre-wrap;
    }
    .bubble-bot {
      background: linear-gradient(to left, #4f46e5, #0ea5e9);
      color: #fff;
      padding: 10px 14px;
      border-radius: 12px;
      margin: 6px 0;
      max-width: 85%;
      align-self: flex-end;
      font-size: 14px;
      line-height: 1.6;
      white-space: pre-wrap;
    }
    .panel {
      background: rgba(15,23,42,0.9);
      border: 1px solid rgba(75,85,99,0.7);
      border-radius: 16px;
      padding: 14px;
    }
    .btn {
      padding: 8px 16px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-weight: 600;
    }
    .btn-send {
      background: linear-gradient(to left, #22c55e, #14b8a6);
      color: #0f172a;
    }
    .btn-admin {
      background: transparent;
      border: 1px solid #facc15;
      color: #facc15;
    }
    .btn-admin.active {
      background: #facc15;
      color: #000;
    }
    select, input, textarea {
      background: #020617;
      color: #e5e7eb;
      border: 1px solid #4b5563;
      border-radius: 8px;
      padding: 8px;
      font-size: 14px;
    }
    textarea {
      resize: none;
    }
  </style>
</head>

<body>
<div id="root">

  <!-- ====== HEADER ====== -->
  <header>
    <div>
      <div style="font-size: 20px; font-weight: 700;">Ù„ÙˆØ­Ø© Ø§Ù„Ù‚Ø´Ø§Ø· â€“ PAI-6 v8</div>
      <div style="font-size: 12px; color: #9ca3af;">
        Ø´Ø§Øª ÙƒØ§Ù…Ù„ + Ø£ÙˆØ¶Ø§Ø¹ ØªØ´ØºÙŠÙ„ + Ù‚Ù†ÙˆØ§Øª + Ù„ÙˆØ­Ø© Ø£Ø¯Ù…Ù† â€“ Ù†Ø³Ø®Ø© HTML ÙÙ‚Ø·.
      </div>
    </div>

    <div style="display:flex; align-items:center; gap:12px;">
      <label style="font-size:12px;">Ø§Ù„ÙˆØ¶Ø¹:</label>
      <select id="modeSelect">
        <option value="general">Ø¹Ø§Ù…</option>
        <option value="ops">ØªØ´ØºÙŠÙ„</option>
        <option value="code">Ø¨Ø±Ù…Ø¬Ø©</option>
        <option value="medical">Ø·Ø¨ÙŠ</option>
        <option value="auto">Ø³ÙŠØ§Ø±Ø§Øª</option>
        <option value="projects">Ù…Ø´Ø§Ø±ÙŠØ¹</option>
      </select>

      <select id="channelSelect">
        <option value="text">Ù†Øµ</option>
        <option value="mic">Ù…Ø§ÙŠÙƒ</option>
        <option value="cam">ÙƒØ§Ù…ÙŠØ±Ø§</option>
        <option value="video">ÙÙŠØ¯ÙŠÙˆ</option>
        <option value="admin">Ø£Ø¯Ù…Ù†</option>
      </select>

      <button id="adminToggle" class="btn btn-admin">ÙˆØ¶Ø¹ Ø§Ù„Ø£Ø¯Ù…Ù†</button>
    </div>
  </header>


  <!-- ====== MAIN BODY (CHAT + ADMIN PANEL) ====== -->
  <div style="
    display:grid;
    grid-template-columns: 1fr 0;
    transition:0.2s;
    gap:12px;
    padding:12px;
  " id="mainGrid">

    <!-- CHAT PANEL -->
    <div class="panel" style="display:flex; flex-direction:column; height:80vh;">
      <div id="messages" style="
        flex:1;
        overflow-y:auto;
        padding:8px;
        display:flex;
        flex-direction:column;
      "></div>

      <div style="border-top:1px solid rgba(55,65,81,0.9); padding-top:8px;">
        <textarea id="inputBox" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ Ù‡Ù†Ø§..." 
          style="width:100%; height:80px;"></textarea>

        <div style="margin-top:8px; display:flex; justify-content:space-between;">
          <div style="font-size:11px; color:#6b7280;">
            Enter Ù„Ù„Ø¥Ø±Ø³Ø§Ù„ â€“ Shift + Enter Ù„Ø³Ø·Ø± Ø¬Ø¯ÙŠØ¯
          </div>
          <button id="sendBtn" class="btn btn-send">Ø¥Ø±Ø³Ø§Ù„</button>
        </div>
      </div>
    </div>

    <!-- ADMIN PANEL -->
    <div id="adminPanel" class="panel" style="
      display:none;
      flex-direction:column;
      gap:12px;
      height:80vh;
      overflow-y:auto;
    ">
      <div style="font-size:14px; font-weight:600;">âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ø¯Ù…Ù†</div>

      <label>Backend URL</label>
      <input id="backendUrl" type="text" placeholder="http://localhost:8000" />

      <label>External API Key (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
      <input id="apiKey" type="password" />

      <hr style="border-color:#4b5563;">

      <div style="font-size:14px; font-weight:600;">ğŸ§  Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¬Ù„Ø³Ø§Øª</div>

      <button id="exportBtn" class="btn" 
        style="background:linear-gradient(to left,#6366f1,#ec4899); color:#fff;">
        ØªØµØ¯ÙŠØ± Ø§Ù„Ø¬Ù„Ø³Ø© (JSON)
      </button>

      <label class="btn" style="
        border:1px solid #4b5563; 
        background:transparent;
        color:#e5e7eb;
        text-align:center;
        padding:8px;
        cursor:pointer;
      ">
        Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¬Ù„Ø³Ø©
        <input id="importFile" type="file" accept="application/json" style="display:none;">
      </label>

      <div style="font-size:12px; color:#9ca3af;">
        * ÙƒÙ„ Ø´ÙŠØ¡ Ù…Ø­ÙÙˆØ¸ ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­ (localStorage)
      </div>
    </div>

  </div>
</div>

<!-- ====================== JS ====================== -->
<script>
  // ====== GLOBAL ======
  let messages = [];
  let sessionId = null;

  const backendUrlInput = document.getElementById("backendUrl");
  const apiKeyInput = document.getElementById("apiKey");

  backendUrlInput.value = localStorage.getItem("pai6_backend_url") || "http://localhost:8000";
  apiKeyInput.value = localStorage.getItem("pai6_api_key") || "";

  backendUrlInput.oninput = () => {
    localStorage.setItem("pai6_backend_url", backendUrlInput.value);
  };
  apiKeyInput.oninput = () => {
    localStorage.setItem("pai6_api_key", apiKeyInput.value);
  };


  // ====== CHAT ======
  const msgBox = document.getElementById("messages");
  const inputBox = document.getElementById("inputBox");
  const sendBtn = document.getElementById("sendBtn");

  function renderMessages() {
    msgBox.innerHTML = "";
    messages.forEach(m => {
      const div = document.createElement("div");
      div.className = m.role === "user" ? "bubble-user" : "bubble-bot";
      div.textContent = m.content;
      msgBox.appendChild(div);
    });
    msgBox.scrollTop = msgBox.scrollHeight;
  }


  async function sendMessage() {
    const text = inputBox.value.trim();
    if (!text) return;

    messages.push({ role: "user", content: text });
    renderMessages();
    inputBox.value = "";

    const payload = {
      message: text,
      channel: document.getElementById("channelSelect").value,
      mode: document.getElementById("modeSelect").value,
      session_id: sessionId,
      history: messages,
      user_name: "Ù†Ø§ØµØ±",
    };

    const headers = { "Content-Type": "application/json" };
    if (apiKeyInput.value.trim()) {
      headers["x-external-api-key"] = apiKeyInput.value.trim();
    }

    try {
      const res = await fetch(backendUrlInput.value + "/api/chat", {
        method: "POST",
        headers,
        body: JSON.stringify(payload),
      });

      if (!res.ok) {
        const err = await res.json().catch(()=>({detail:"unknown"}));
        messages.push({
          role: "assistant",
          content: "âŒ Ø®Ø·Ø£ Ù…Ù† Ø§Ù„Ø¨Ø§Ùƒ Ø¥Ù†Ø¯:\n" + err.detail
        });
      } else {
        const data = await res.json();
        sessionId = data.session_id;
        messages.push({
          role: "assistant",
          content: data.reply
        });
      }

    } catch (err) {
      messages.push({
        role: "assistant",
        content: "âŒ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¨Ø§Ùƒ Ø¥Ù†Ø¯:\n" + err.message,
      });
    }

    renderMessages();
  }


  sendBtn.onclick = sendMessage;
  inputBox.onkeydown = (e) => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  };


  // ===== ADMIN PANEL =====
  const adminToggle = document.getElementById("adminToggle");
  const adminPanel = document.getElementById("adminPanel");
  const mainGrid = document.getElementById("mainGrid");

  adminToggle.onclick = () => {
    const show = adminPanel.style.display === "none";
    adminPanel.style.display = show ? "flex" : "none";
    adminToggle.classList.toggle("active", show);
    mainGrid.style.gridTemplateColumns = show ? "2fr 1fr" : "1fr 0";
  };


  // ===== EXPORT =====
  document.getElementById("exportBtn").onclick = () => {
    const data = {
      messages,
      sessionId,
      ts: new Date().toISOString(),
    };
    const blob = new Blob([JSON.stringify(data, null, 2)], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `pai6_session_${Date.now()}.json`;
    a.click();
    URL.revokeObjectURL(url);
  };

  // ===== IMPORT =====
  document.getElementById("importFile").onchange = (e) => {
    const file = e.target.files?.[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (ev) => {
      try {
        const data = JSON.parse(ev.target.result);
        messages = data.messages || [];
        sessionId = data.sessionId || null;
        renderMessages();
      } catch {
        alert("Ø§Ù„Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­.");
      }
    };
    reader.readAsText(file);
  };
  // Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„ÙØªØ­/Ø¥ØºÙ„Ø§Ù‚ Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¯Ù…Ù† Ø¨Ø±Ù…Ø¬ÙŠØ§Ù‹
function setAdminMode(on) {
  adminPanel.style.display = on ? "flex" : "none";
  adminToggle.classList.toggle("active", on);
  mainGrid.style.gridTemplateColumns = on ? "2fr 1fr" : "1fr 0";
}

// ØªØ¹Ø¯ÙŠÙ„ ÙƒÙ„ÙŠÙƒ Ø§Ù„Ø²Ø± Ù„ÙŠØ³ØªØ®Ø¯Ù… Ø§Ù„Ø¯Ø§Ù„Ø©
adminToggle.onclick = () => {
  const show = adminPanel.style.display === "none";
  setAdminMode(show);
};

// ÙØªØ­ Ø§Ù„Ø£Ø¯Ù…Ù† ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù„Ùˆ Ø§Ù„Ø±Ø§Ø¨Ø· ÙÙŠÙ‡ ?admin=1
const params = new URLSearchParams(window.location.search);
if (params.get("admin") === "1") {
  setAdminMode(true);
}

</script>

</body>
</html>